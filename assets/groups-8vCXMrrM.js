import{c as i,d as u}from"./auth-HNLA2NWH.js";import{addDoc as L,collection as b,serverTimestamp as M,query as k,orderBy as S,onSnapshot as I,doc as w,getDoc as f,updateDoc as x,arrayUnion as U,arrayRemove as A,deleteDoc as R}from"https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";function $(e){if(!e||typeof e!="string")return!1;const n=e.trim();return n.length>=2&&n.length<=100}function E(e){return String(e).trim().slice(0,100)}async function C(){const e=i.currentUser;if(!e){alert("You must be logged in to create a group");return}const n=prompt("Enter group name (2-100 characters):");if(n){if(!$(n)){alert("Group name must be between 2 and 100 characters");return}try{const t=E(n);await L(b(u,"groups"),{name:t,createdBy:e.uid,createdAt:M(),members:[e.uid],maxSize:10}),alert("Group created!")}catch(t){const o=t.code?"Error creating group. Please try again.":t.message;alert(o)}}}async function G(e){const n=i.currentUser;if(!n){alert("You must be logged in to join a group");return}try{const t=w(u,"groups",e),o=await f(t);if(!o.exists()){alert("Group not found");return}const r=o.data();if((r.members||[]).includes(n.uid)){alert("You're already in this group!");return}if((r.members||[]).length>=(r.maxSize||10)){alert("Group is full!");return}await x(t,{members:U(n.uid)}),alert("Joined group!")}catch(t){const o=t.code?"Error joining group. Please try again.":t.message;alert(o)}}async function B(e){const n=i.currentUser;if(!n){alert("You must be logged in to leave a group");return}try{const t=w(u,"groups",e);if(!(await f(t)).exists()){alert("Group not found");return}await x(t,{members:A(n.uid)});const r=await f(t);(r.exists()?r.data().members||[]:[]).length===0&&await R(t),alert("Left group!")}catch(t){const o=t.code?"Error leaving group. Please try again.":t.message;alert(o)}}function l(){const e=document.getElementById("groupsList");if(!e)return;e.innerHTML="";const n=document.createElement("h2");n.textContent="All Groups",e.appendChild(n);const t=k(b(u,"groups"),S("createdAt","desc"));I(t,o=>{if(e.innerHTML="",e.appendChild(n),o.empty){const s=document.createElement("p");s.textContent="No groups yet. Create one!",e.appendChild(s);return}const r=document.createElement("table");r.style.border="1px solid #ccc",r.style.borderCollapse="collapse",r.style.width="100%";const d=r.insertRow();["Group","Members","Action"].forEach(s=>{const a=document.createElement("th");a.textContent=s,a.style.border="1px solid #ccc",a.style.padding="8px",d.appendChild(a)}),o.forEach(s=>{const a=s.data(),m=r.insertRow(),p=m.insertCell(0);p.textContent=`${E(a.name)} (${(a.members||[]).length}/${a.maxSize||10})`,p.style.border="1px solid #ccc",p.style.padding="8px";const g=m.insertCell(1);g.textContent=`${(a.members||[]).length} member${(a.members||[]).length!==1?"s":""}`,g.style.border="1px solid #ccc",g.style.padding="8px";const h=m.insertCell(2);h.style.border="1px solid #ccc",h.style.padding="8px";const c=document.createElement("button"),y=i.currentUser;y&&(a.members||[]).includes(y.uid)?(c.textContent="Leave",c.addEventListener("click",()=>B(s.id))):(c.textContent="Join",c.addEventListener("click",()=>G(s.id))),h.appendChild(c)}),e.appendChild(r)},o=>{const r=document.createElement("p");r.textContent="Error loading groups. Please try again.",e.appendChild(r)})}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("createGroupBtn"),n=document.getElementById("refreshGroupsBtn"),t=document.getElementById("backHomeBtn"),o=document.getElementById("logoutBtn");e&&e.addEventListener("click",C),n&&n.addEventListener("click",l),t&&t.addEventListener("click",()=>window.location.href="homepage.html"),o&&o.addEventListener("click",()=>{i.signOut().then(()=>window.location.href="index.html")}),i.currentUser?l():onAuthStateChanged(i,d=>{d?l():(alert("Please login first!"),window.location.href="index.html")})});window.createGroup=C;window.joinGroup=G;window.leaveGroup=B;window.showGroups=l;const v=firebase.auth();v.onAuthStateChanged(e=>{e?document.getElementById("username").textContent=e.email.split("@")[0]:document.getElementById("username").textContent="Guest"});window.logout=function(){v.signOut().then(()=>{window.location.href="index.html"})};
